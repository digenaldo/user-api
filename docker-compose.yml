version: '3.8'

# Define os serviços (containers) que vamos rodar
services:
  # Serviço do MongoDB - nosso banco de dados
  mongo:
    # Usa a imagem oficial do MongoDB versão 7.0
    image: mongo:7.0
    
    # Expõe a porta 27017 (porta padrão do MongoDB) para o host
    # Formato: "host:container" - permite acessar de fora do container
    ports:
      - "27017:27017"
    
    # Variáveis de ambiente para configurar o MongoDB
    # Essas variáveis são lidas na primeira inicialização
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
    
    # Volume para persistir os dados do MongoDB
    # Se o container for removido, os dados ficam salvos no volume
    volumes:
      - mongo_data:/data/db

  # Serviço da nossa API
  api:
    # Constrói a imagem usando o Dockerfile na raiz do projeto
    build: .
    
    # Garante que o MongoDB inicie antes da API
    # Importante: isso só garante a ordem, não espera o MongoDB estar pronto
    # Por isso nossa aplicação tem lógica de reconexão
    depends_on:
      - mongo
    
    # Variáveis de ambiente que a aplicação vai ler
    environment:
      # URI de conexão: mongodb://usuário:senha@host:porta/?authSource=admin
      # O host é "mongo" porque é o nome do serviço no docker-compose
      # Dentro da rede Docker, os serviços se comunicam pelo nome
      MONGO_URI: mongodb://root:root@mongo:27017/?authSource=admin
      PORT: 8080
    
    # Expõe a porta 8080 da API para o host
    ports:
      - "8080:8080"

# Define volumes nomeados (persistência de dados)
volumes:
  mongo_data:
    # Este volume armazena os dados do MongoDB
    # Permanece mesmo se removermos o container

# Notas importantes:
# - depends_on garante ordem de inicialização, mas não verifica se o serviço está pronto
#   Por isso nossa aplicação tenta reconectar automaticamente se o banco ainda não estiver disponível
# - Para usar com Podman: `podman compose up --build` (mesma sintaxe do Docker)
# - As credenciais root/root são apenas para desenvolvimento - NUNCA use em produção
# - Os serviços se comunicam pela rede interna do Docker usando os nomes (mongo, api)
